<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casey Family Chores</title>
    <meta name="theme-color" content="#ffffff"/>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Lexend', sans-serif; }
        
        /* --- Main App Styles --- */
        #columns-container { gap: 0; }
        .child-column { border-right: 1px solid #e5e7eb; }
        .child-column:last-child { border-right: none; }
        .chore-item {
            border-radius: 0;
            box-shadow: none;
            border-bottom: 1px solid #f3f4f6;
            padding: 6px 8px;
        }
        .dragging { opacity: 0.5; background: #f0f0f0; border: 2px dashed #ccc; }
        .drag-over { background-color: #eef2ff; }
        .warning-icon { display: inline-block; vertical-align: middle; }
        .day-btn.selected { background-color: #4f46e5; color: white; border-color: #4f46e5; }
        .day-btn { transition: background-color 0.2s, color 0.2s, border-color 0.2s; }
        .hidden { display: none; }

        /* --- Print-Specific Styles --- */
        @media print {
            body { 
                -webkit-print-color-adjust: exact; 
                color-adjust: exact; 
                background-color: white !important;
            }
            .no-print { display: none !important; }
            #chore-board { 
                box-shadow: none !important; 
                border: none !important; 
                padding: 0 !important;
            }
            #columns-container {
                display: grid;
                grid-template-columns: repeat(2, 1fr); /* Creates two columns */
                gap: 20px; /* Adds a gap between the two columns */
            }
            .child-column { 
                page-break-inside: avoid; /* Tries to keep a child's list from splitting across pages */
                border: none !important; 
                background-color: white !important;
                padding: 0 !important;
            }
            .chore-list {
                space-y-1.5: 0 !important; /* Removes space between chore items for print */
            }
            .chore-item { 
                border: none;
                border-top: 1px solid #374151; /* dark gray separator */
                padding: 4px 0;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">

    <div id="signin-container" class="text-center mt-20">
        <button id="google-signin-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-colors">
            Sign In with Google
        </button>
    </div>

    <div id="main-content" class="max-w-screen-2xl mx-auto hidden">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 no-print gap-4">
            <div>
                <select id="chore-block-select" class="text-2xl font-bold text-gray-900 border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"></select>
                <p id="chore-block-header" class="text-lg text-gray-600 mt-1">
                    Time Range: <span id="start-time" contenteditable="true" class="font-semibold px-1 rounded-md"></span>-<span id="end-time" contenteditable="true" class="font-semibold px-1 rounded-md"></span>
                </p>
            </div>
            <div class="flex space-x-2">
                 <button id="open-add-modal-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition-colors">
                    Add New Chore
                </button>
                <button onclick="window.print()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                    Print Chores
                </button>
            </div>
        </div>

        <div id="chore-board" class="chore-board bg-white p-4 sm:p-6 rounded-2xl shadow-lg">
            <div id="columns-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6">
                <!-- Child columns will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Add/Edit Chore Modal -->
    <div id="chore-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full no-print z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900 text-center">Edit Chore</h3>
                <form id="chore-form" class="mt-4 space-y-4">
                    <input type="hidden" id="edit-chore-id">
                    <input type="hidden" id="edit-child-id">
                    <div id="modal-child-select-container" class="hidden">
                        <label for="modal-child-select" class="text-sm font-medium text-gray-700 block">Assign to Child</label>
                        <select id="modal-child-select" name="child" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                    </div>
                    <div>
                        <label for="modal-task-input" class="text-sm font-medium text-gray-700 block">Chore Description</label>
                        <textarea id="modal-task-input" name="task" rows="2" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="modal-time-input" class="text-sm font-medium text-gray-700 block">Start Time</label>
                            <input type="time" id="modal-time-input" name="time" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                        </div>
                        <div>
                            <label for="modal-duration-input" class="text-sm font-medium text-gray-700 block">Duration (min)</label>
                            <input type="number" id="modal-duration-input" name="duration" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="10" required>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700 block">Days</label>
                        <div id="day-selector" class="mt-2 grid grid-cols-7 gap-1"></div>
                    </div>
                    <div class="flex items-center pt-3 space-x-2">
                        <button id="save-chore-btn" type="submit" class="flex-grow w-full px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Save Changes</button>
                        <button id="delete-chore-btn" type="button" class="flex-shrink-0 px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Delete</button>
                    </div>
                </form>
                <button id="close-modal-btn" class="mt-2 text-sm text-gray-500 hover:text-gray-700 w-full text-center">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center no-print z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-auto">
            <h3 id="confirm-modal-title" class="text-lg font-medium text-gray-900">Are you sure?</h3>
            <p id="confirm-modal-text" class="mt-2 text-sm text-gray-500">Do you really want to delete this chore? This action cannot be undone.</p>
            <div class="mt-4 flex justify-end space-x-3">
                <button id="confirm-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="confirm-ok-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>

    <script id="app-script">
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCXWZN9QZkIqXyx234nBOTI3M7rcGNU9p8",
            authDomain: "casey-family-chores.firebaseapp.com",
            projectId: "casey-family-chores",
            storageBucket: "casey-family-chores.appspot.com",
            messagingSenderId: "211060942093",
            appId: "1:211060942093:web:83973adc673dcfd1f77c44"
        };
        
        let defaultAppData; 
        let appData = null;
        let draggedChore = null;
        let db;

        // --- FIREBASE INITIALIZATION ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        db = firebase.firestore();
        const choreRef = db.collection('app').doc('choreData');

        // --- AUTHENTICATION LOGIC ---
        const signInContainer = document.getElementById('signin-container');
        const mainContent = document.getElementById('main-content');
        const provider = new firebase.auth.GoogleAuthProvider();

        document.getElementById('google-signin-btn').addEventListener('click', () => {
            auth.signInWithPopup(provider).catch(error => console.error("Google sign-in failed:", error));
        });

        auth.onAuthStateChanged(user => {
            if (user) {
                const authorizedEmails = ['virgil.durden@gmail.com', 'your.wife@example.com'];
                if (authorizedEmails.includes(user.email)) {
                    signInContainer.style.display = 'none';
                    mainContent.classList.remove('hidden');
                    choreRef.onSnapshot(doc => {
                        if (doc.exists) {
                            appData = doc.data();
                            renderBoard();
                        } else {
                            defaultAppData = {
                                children: [ { id: 'tristan', name: 'Tristan', color: '#F97316' }, { id: 'dylan', name: 'Dylan', color: '#3B82F6' }, { id: 'william', name: 'William', color: '#22C55E' }, { id: 'vivian', name: 'Vivian', color: '#EC4899' }, { id: 'eleanor', name: 'Eleanor', color: '#8B5CF6' }, { id: 'nathan', name: 'Nathan', color: '#6B7280' } ],
                                activeBlockId: 'block1',
                                choreBlocks: [ { id: 'block1', title: 'Block 1: Morning Chores', startTime: '6:00', endTime: '7:00', chores: {} } ]
                            };
                            appData = defaultAppData;
                            saveData();
                        }
                    }, err => console.error("Error listening to chore data:", err));
                } else {
                    alert("You are not authorized to access this application.");
                    auth.signOut();
                }
            } else {
                signInContainer.style.display = 'block';
                mainContent.classList.add('hidden');
            }
        });

        // --- CORE LOGIC & UTILITIES ---
        function saveData() { if (auth.currentUser) { choreRef.set(appData).catch(error => console.error("Error writing document: ", error)); } }
        function getActiveBlock() { if (!appData) return null; return appData.choreBlocks.find(b => b.id === appData.activeBlockId); }
        function timeToMinutes(timeStr) { if (!timeStr || !timeStr.includes(':')) return 0; const [hours, minutes] = timeStr.split(':').map(Number); return (hours * 60) + minutes; }
        function minutesToTime(totalMinutes) { const hours = Math.floor(totalMinutes / 60); const minutes = totalMinutes % 60; return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`; }
        function formatTime(timeStr) { if (!timeStr || !timeStr.includes(':')) return ''; let [hours, minutes] = timeStr.split(':'); return `${parseInt(hours, 10)}:${minutes}`; }
        function recalculateTimes(childId) { const block = getActiveBlock(); if (!block) return; const chores = block.chores[childId]; if (!chores || chores.length === 0) return; for (let i = 1; i < chores.length; i++) { const prevChore = chores[i - 1]; const prevStartTimeMinutes = timeToMinutes(prevChore.time); const prevDurationMinutes = parseInt(prevChore.duration, 10) || 0; chores[i].time = minutesToTime(prevStartTimeMinutes + prevDurationMinutes); } }
        function recalculateFollowingChores(childId, startIndex) { const block = getActiveBlock(); if (!block) return; const chores = block.chores[childId]; if (!chores || chores.length < 2) return; for (let i = startIndex + 1; i < chores.length; i++) { const prevChore = chores[i - 1]; const prevStartTimeMinutes = timeToMinutes(prevChore.time); const prevDurationMinutes = parseInt(prevChore.duration, 10) || 0; chores[i].time = minutesToTime(prevStartTimeMinutes + prevDurationMinutes); } }
        function calculateTotalDuration(childId) { const block = getActiveBlock(); if (!block) return 0; const chores = block.chores[childId] || []; return chores.reduce((total, chore) => total + (parseInt(chore.duration, 10) || 0), 0); }
        function checkAllOverages() { const block = getActiveBlock(); if (!block) return; const totalBlockMinutes = timeToMinutes(block.endTime) - timeToMinutes(block.startTime); appData.children.forEach(child => { const childsTotalDuration = calculateTotalDuration(child.id); const warningIcon = document.getElementById(`warning-${child.id}`); if (warningIcon) { warningIcon.classList.toggle('hidden', childsTotalDuration <= totalBlockMinutes); } }); }
        function updateChoreBlockHeader() { const block = getActiveBlock(); if (!block) return; document.getElementById('start-time').innerText = block.startTime; document.getElementById('end-time').innerText = block.endTime; }
        function populateBlockSelector() { const select = document.getElementById('chore-block-select'); select.innerHTML = ''; appData.choreBlocks.forEach(block => { const option = document.createElement('option'); option.value = block.id; option.textContent = block.title; if (block.id === appData.activeBlockId) { option.selected = true; } select.appendChild(option); }); }

        function renderBoard() {
            if (!appData) return;
            populateBlockSelector();
            updateChoreBlockHeader();
            const container = document.getElementById('columns-container');
            container.innerHTML = '';
            const block = getActiveBlock();
            if (!block) return;
            appData.children.forEach(child => {
                const column = document.createElement('div');
                column.id = `column-${child.id}`;
                column.className = 'child-column bg-gray-50 p-2 flex flex-col space-y-2';
                column.dataset.childId = child.id;
                column.innerHTML = `
                    <h2 class="text-lg font-bold text-center text-white p-2 flex items-center justify-center" style="background-color: ${child.color};">
                        ${child.name}
                        <span id="warning-${child.id}" class="warning-icon hidden ml-2" title="Chores exceed available time!">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-300" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </span>
                    </h2>
                    <div id="chores-${child.id}" class="chore-list flex-grow min-h-[200px]"></div>
                    <button class="add-chore-btn no-print mt-2 w-full bg-gray-200 text-gray-700 font-semibold py-1.5 px-2 rounded-lg hover:bg-gray-300 transition-colors text-sm" data-child-id="${child.id}">+ Add Chore</button>
                `;
                const choreList = column.querySelector(`#chores-${child.id}`);
                (block.chores[child.id] || []).forEach(chore => {
                    choreList.appendChild(createChoreElement(chore, child.id));
                });
                container.appendChild(column);
            });
            checkAllOverages();
            addEventListeners();
        }
        
        function formatDays(daysArray) {
            const dayLabels = ['m', 't', 'w', 'th', 'f', 'sa', 'su'];
            if (!daysArray || !Array.isArray(daysArray) || daysArray.every(d => d)) return '';
            const weekdays = daysArray.slice(0, 5);
            const weekends = daysArray.slice(5, 7);
            if (weekdays.every(d => d) && weekends.every(d => !d)) return 'Weekdays';
            if (weekdays.every(d => !d) && weekends.every(d => d)) return 'Weekends';
            return daysArray.map((isSelected, i) => isSelected ? dayLabels[i] : null).filter(Boolean).join(', ') || '';
        }

        function createChoreElement(chore, childId) {
            const choreItem = document.createElement('div');
            choreItem.id = chore.id;
            choreItem.className = 'chore-item bg-white cursor-pointer hover:bg-gray-50';
            choreItem.dataset.choreId = chore.id;
            choreItem.dataset.childId = childId;
            choreItem.innerHTML = `
                <!-- Screen View (hidden on print) -->
                <div class="hidden sm:block print:hidden">
                    <div class="flex justify-between items-center text-xs">
                        <div class="chore-time font-medium text-gray-600">${formatTime(chore.time)}</div>
                        <div class="days-display text-gray-400 font-medium">${formatDays(chore.days)}</div>
                    </div>
                    <p class="chore-task text-gray-800 text-sm mt-1">${chore.task}</p>
                </div>
                <!-- Print View (only visible on print) -->
                <div class="hidden print:flex items-baseline text-sm">
                    <span class="chore-time font-medium text-gray-600 w-12">${formatTime(chore.time)}</span>
                    <span class="chore-task text-gray-800 flex-1">${chore.task}</span>
                    <span class="days-display text-gray-500 text-xs ml-2">${formatDays(chore.days)}</span>
                </div>
            `;
            return choreItem;
        }

        function addEventListeners() {
            document.querySelectorAll('.chore-item').forEach(i => { 
                i.addEventListener('click', (e) => openEditModal(e.currentTarget.dataset.childId, e.currentTarget.dataset.choreId));
                i.draggable = true;
                i.addEventListener('dragstart', handleDragStart); 
                i.addEventListener('dragend', handleDragEnd); 
            });
            document.querySelectorAll('.chore-list').forEach(l => { l.addEventListener('dragover', handleDragOver); l.addEventListener('dragleave', handleDragLeave); l.addEventListener('drop', handleDrop); });
            document.querySelectorAll('[contenteditable="true"]').forEach(f => { f.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); e.target.blur(); } }); });
            document.getElementById('start-time').addEventListener('blur', handleTimeRangeEdit);
            document.getElementById('end-time').addEventListener('blur', handleTimeRangeEdit);
            document.querySelectorAll('.add-chore-btn').forEach(b => b.addEventListener('click', (e) => openAddModal(e.currentTarget.dataset.childId)));
            document.getElementById('open-add-modal-btn').addEventListener('click', () => openAddModal());
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            document.getElementById('chore-form').addEventListener('submit', handleSaveChore);
            document.getElementById('delete-chore-btn').addEventListener('click', handleDeleteChoreFromModal);
            document.getElementById('chore-block-select').addEventListener('change', handleBlockChange);
        }

        function openAddModal(childId = null) {
            const modal = document.getElementById('chore-modal');
            const form = document.getElementById('chore-form');
            form.reset();
            document.getElementById('modal-title').textContent = 'Add New Chore';
            document.getElementById('edit-chore-id').value = '';
            const childSelectContainer = document.getElementById('modal-child-select-container');
            const childSelect = document.getElementById('modal-child-select');
            if (childId) {
                document.getElementById('edit-child-id').value = childId;
                childSelectContainer.classList.add('hidden');
            } else {
                childSelectContainer.classList.remove('hidden');
                childSelect.innerHTML = '';
                appData.children.forEach(child => {
                    const option = document.createElement('option');
                    option.value = child.id;
                    option.textContent = child.name;
                    childSelect.appendChild(option);
                });
                document.getElementById('edit-child-id').value = childSelect.value;
            }
            const daySelector = document.getElementById('day-selector');
            const days = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
            daySelector.innerHTML = '';
            days.forEach((day, index) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.textContent = day;
                button.dataset.dayIndex = index;
                button.className = 'day-btn border rounded-md py-2 text-sm font-medium bg-white text-gray-700 hover:bg-gray-50';
                button.classList.add('selected');
                button.addEventListener('click', () => button.classList.toggle('selected'));
                daySelector.appendChild(button);
            });
            document.getElementById('delete-chore-btn').classList.add('hidden');
            modal.classList.remove('hidden');
        }

        function openEditModal(childId, choreId) {
            const modal = document.getElementById('chore-modal');
            const form = document.getElementById('chore-form');
            const block = getActiveBlock();
            const chore = block.chores[childId].find(c => c.id === choreId);
            if (!chore) return;
            document.getElementById('modal-title').textContent = 'Edit Chore';
            document.getElementById('edit-chore-id').value = choreId;
            document.getElementById('edit-child-id').value = childId;
            form.elements.task.value = chore.task;
            form.elements.time.value = chore.time;
            form.elements.duration.value = chore.duration;
            document.getElementById('modal-child-select-container').classList.add('hidden');
            const daySelector = document.getElementById('day-selector');
            const days = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
            daySelector.innerHTML = '';
            (chore.days || [true,true,true,true,true,true,true]).forEach((isSelected, index) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.textContent = days[index];
                button.dataset.dayIndex = index;
                button.className = 'day-btn border rounded-md py-2 text-sm font-medium bg-white text-gray-700 hover:bg-gray-50';
                if (isSelected) button.classList.add('selected');
                button.addEventListener('click', () => button.classList.toggle('selected'));
                daySelector.appendChild(button);
            });
            document.getElementById('delete-chore-btn').classList.remove('hidden');
            modal.classList.remove('hidden');
        }

        function closeModal() { document.getElementById('chore-modal').classList.add('hidden'); }
        function handleBlockChange(e) { appData.activeBlockId = e.target.value; saveData(); }

        function handleTimeRangeEdit(e) {
            const block = getActiveBlock();
            if (!block) return;
            const field = e.target.id === 'start-time' ? 'startTime' : 'endTime';
            const newTime = e.target.innerText.trim();
            if (/^\d{1,2}:\d{2}$/.test(newTime)) {
                block[field] = newTime;
                if (field === 'startTime') {
                    appData.children.forEach(child => {
                        const choreList = block.chores[child.id];
                        if (choreList && choreList.length > 0) {
                            choreList[0].time = newTime;
                            recalculateTimes(child.id);
                        }
                    });
                }
                saveData();
            } else {
                e.target.innerText = block[field];
            }
        }

        function handleSaveChore(e) {
            e.preventDefault();
            const block = getActiveBlock();
            if (!block) return;
            const form = e.target;
            const choreId = document.getElementById('edit-chore-id').value;
            let childId = document.getElementById('edit-child-id').value;
            const task = form.elements.task.value;
            const time = form.elements.time.value;
            const duration = parseInt(form.elements.duration.value, 10) || 0;
            const savedChoreId = choreId || 'c' + Date.now();
            const selectedDays = Array.from(document.querySelectorAll('#day-selector .day-btn')).map(btn => btn.classList.contains('selected'));
            if (!task.trim()) return;
            if (choreId) {
                const choreList = block.chores[childId];
                const choreIndex = choreList.findIndex(c => c.id === choreId);
                if (choreIndex > -1) {
                    const chore = choreList[choreIndex];
                    chore.task = task; chore.time = time; chore.duration = duration; chore.days = selectedDays;
                }
            } else {
                childId = document.getElementById('modal-child-select').value;
                const newChore = { id: savedChoreId, time, duration, task, days: selectedDays };
                if (!block.chores[childId]) block.chores[childId] = [];
                block.chores[childId].push(newChore);
            }
            block.chores[childId].sort((a, b) => timeToMinutes(a.time) - timeToMinutes(b.time));
            const savedChoreIndex = block.chores[childId].findIndex(c => c.id === savedChoreId);
            recalculateFollowingChores(childId, savedChoreIndex);
            closeModal();
            saveData();
        }
        
        function handleDragStart(e) { draggedChore = { choreId: e.target.id, sourceChildId: e.target.closest('.child-column').dataset.childId }; e.target.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; }
        function handleDragEnd(e) { e.target.classList.remove('dragging'); draggedChore = null; }
        function handleDragOver(e) { e.preventDefault(); e.currentTarget.closest('.child-column').classList.add('drag-over'); }
        function handleDragLeave(e) { e.currentTarget.closest('.child-column').classList.remove('drag-over'); }

        function handleDrop(e) {
            e.preventDefault();
            const block = getActiveBlock();
            if (!block) return;
            const dropList = e.currentTarget;
            dropList.closest('.child-column').classList.remove('drag-over');
            if (!draggedChore) return;
            const targetChildId = dropList.closest('.child-column').dataset.childId;
            const { choreId, sourceChildId } = draggedChore;
            const sourceChores = block.chores[sourceChildId];
            const choreIndex = sourceChores.findIndex(c => c.id === choreId);
            if (choreIndex === -1) return;
            const [movedChore] = sourceChores.splice(choreIndex, 1);
            const targetChores = block.chores[targetChildId] || [];
            const afterElement = [...dropList.querySelectorAll('.chore-item:not(.dragging)')].reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = e.clientY - box.top - box.height / 2;
                return (offset < 0 && offset > closest.offset) ? { offset, element: child } : closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
            if (afterElement == null) {
                targetChores.push(movedChore);
            } else {
                const insertIndex = targetChores.findIndex(c => c.id === afterElement.id);
                targetChores.splice(insertIndex, 0, movedChore);
            }
            if (!block.chores[targetChildId]) block.chores[targetChildId] = targetChores;
            recalculateTimes(sourceChildId);
            recalculateTimes(targetChildId);
            saveData();
        }
        
        function handleDeleteChoreFromModal() {
            const choreId = document.getElementById('edit-chore-id').value;
            const childId = document.getElementById('edit-child-id').value;
            if (!choreId || !childId) return;
            const confirmModal = document.getElementById('confirm-modal');
            const confirmOkBtn = document.getElementById('confirm-ok-btn');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
            confirmModal.classList.remove('hidden');
            const onConfirm = () => {
                const block = getActiveBlock();
                if (!block) return;
                const choreList = block.chores[childId];
                const choreIndex = choreList.findIndex(c => c.id === choreId);
                if (choreIndex > -1) {
                    choreList.splice(choreIndex, 1);
                    recalculateTimes(childId);
                    closeModal();
                    saveData();
                }
                cleanup();
            };
            const cleanup = () => {
                confirmModal.classList.add('hidden');
                confirmOkBtn.removeEventListener('click', onConfirm);
                confirmCancelBtn.removeEventListener('click', cleanup);
            };
            confirmOkBtn.addEventListener('click', onConfirm);
            confirmCancelBtn.addEventListener('click', cleanup);
        }

        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</ht