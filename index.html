<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casey Family Chores</title>
    <meta name="theme-color" content="#ffffff"/>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-hidden { display: none; }
        @media print {
            body { -webkit-print-color-adjust: exact; color-adjust: exact; }
            .no-print { display: none !important; }
            .chore-board { box-shadow: none !important; border: none !important; }
            .child-column { page-break-inside: avoid; }
            .chore-item { border: 1px solid #e2e8f0; }
        }
        .dragging { opacity: 0.5; background: #f0f0f0; border: 2px dashed #ccc; }
        .drag-over { background-color: #eef2ff; }
        .warning-icon { display: inline-block; vertical-align: middle; }
        .day-btn.selected { background-color: #4f46e5; color: white; border-color: #4f46e5; }
        .day-btn { transition: background-color 0.2s, color 0.2s, border-color 0.2s; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">

    <!-- Sign-in button container -->
    <div id="signin-container" class="text-center mt-20">
        <button id="google-signin-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-colors">
            Sign In with Google
        </button>
    </div>

    <!-- Main content, hidden by default -->
    <div id="main-content" class="max-w-screen-2xl mx-auto" style="display: none;">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 no-print gap-4">
            <div>
                <select id="chore-block-select" class="text-2xl font-bold text-gray-900 border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"></select>
                <p id="chore-block-header" class="text-lg text-gray-600 mt-1">
                    Time Range: <span id="start-time" contenteditable="true" class="font-semibold px-1 rounded-md"></span>-<span id="end-time" contenteditable="true" class="font-semibold px-1 rounded-md"></span>
                </p>
            </div>
            <div class="flex space-x-2">
                 <button id="open-add-modal-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition-colors">
                    Add New Chore
                </button>
                <button onclick="window.print()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                    Print Chores
                </button>
            </div>
        </div>

        <div id="chore-board" class="chore-board bg-white p-4 sm:p-6 rounded-2xl shadow-lg">
            <div id="columns-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                <!-- Child columns will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Add/Edit Chore Modal -->
    <div id="chore-modal" class="modal-hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full no-print z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900 text-center">Edit Chore</h3>
                <form id="chore-form" class="mt-4 space-y-4">
                    <input type="hidden" id="edit-chore-id">
                    <input type="hidden" id="edit-child-id">
                    
                    <div id="modal-child-select-container" class="modal-hidden">
                        <label for="modal-child-select" class="text-sm font-medium text-gray-700 block">Assign to Child</label>
                        <select id="modal-child-select" name="child" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>

                    <div>
                        <label for="modal-task-input" class="text-sm font-medium text-gray-700 block">Chore Description</label>
                        <textarea id="modal-task-input" name="task" rows="2" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="modal-time-input" class="text-sm font-medium text-gray-700 block">Start Time</label>
                            <input type="time" id="modal-time-input" name="time" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                        </div>
                        <div>
                            <label for="modal-duration-input" class="text-sm font-medium text-gray-700 block">Duration (min)</label>
                            <input type="number" id="modal-duration-input" name="duration" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="10" required>
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-sm font-medium text-gray-700 block">Days</label>
                        <div id="day-selector" class="mt-2 grid grid-cols-7 gap-1">
                            <!-- Day buttons will be populated by JS -->
                        </div>
                    </div>

                    <div class="flex items-center pt-3 space-x-2">
                        <button id="save-chore-btn" type="submit" class="flex-grow w-full px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Save Changes
                        </button>
                        <button id="delete-chore-btn" type="button" class="flex-shrink-0 px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                            Delete
                        </button>
                    </div>
                </form>
                <button id="close-modal-btn" class="mt-2 text-sm text-gray-500 hover:text-gray-700 w-full text-center">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>

    <script id="app-script">
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCXWZN9QZkIqXyx234nBOTI3M7rcGNU9p8",
            authDomain: "casey-family-chores.firebaseapp.com",
            projectId: "casey-family-chores",
            storageBucket: "casey-family-chores.appspot.com",
            messagingSenderId: "211060942093",
            appId: "1:211060942093:web:83973adc673dcfd1f77c44"
        };
        
        // --- DATA STORE ---
        const defaultAppData = {
            children: [
                { id: 'tristan', name: 'Tristan', color: '#F97316' }, { id: 'dylan', name: 'Dylan', color: '#3B82F6' },
                { id: 'william', name: 'William', color: '#22C55E' }, { id: 'vivian', name: 'Vivian', color: '#EC4899' },
                { id: 'eleanor', name: 'Eleanor', color: '#8B5CF6' }, { id: 'nathan', name: 'Nathan', color: '#6B7280' }
            ],
            activeBlockId: 'block1',
            choreBlocks: [
                { id: 'block1', title: 'Block 1: Morning Chores', startTime: '6:00', endTime: '7:00', chores: {
                    tristan: [ { "id": "c1", "time": "6:00", "duration": 3, "task": "Bring water bottle to take pill", "days": [true,true,true,true,true,true,true] }, { "id": "c8", "time": "6:03", "duration": 1, "task": "Put Tristan water bottle in tote", "days": [true,true,true,true,true,true,true] }, { "id": "c2", "time": "6:04", "duration": 3, "task": "Take both dogs outside to pee", "days": [true,true,true,true,true,true,true] }, { "id": "c1754272607396", "time": "6:07", "duration": 10, "task": "Start oatmeal/ Breakfast prep", "days": [true,true,true,true,true,true,true] }, { "id": "c5", "time": "6:17", "duration": 2, "task": "Take chairs off of dining table", "days": [true,true,true,true,true,true,true] }, { "id": "c4", "time": "6:19", "duration": 3, "task": "Prep sippy cups for littles", "days": [true,true,true,true,true,true,true] }, { "id": "c3", "time": "6:22", "duration": 5, "task": "Clear dish rack", "days": [true,true,true,true,true,true,true] }, { "id": "c7", "time": "6:27", "duration": 3, "task": "Brush teeth", "days": [true,true,true,true,true,true,true] }, { "id": "c9", "time": "6:30", "duration": 12, "task": "Shower & wash face", "days": [true,true,true,true,true,true,true] }, { "id": "c10", "time": "6:42", "duration": 3, "task": "Get dressed", "days": [true,true,true,true,true,true,true] }, { "id": "c11", "time": "6:45", "duration": 2, "task": "Brush hair", "days": [true,true,true,true,true,true,true] }, { "id": "c12", "time": "6:47", "duration": 2, "task": "Make bed", "days": [true,true,true,true,true,true,true] }, { "id": "c13", "time": "6:49", "duration": 5, "task": "Clean room", "days": [true,true,true,true,true,true,true] } ],
                    dylan: [ { "id": "c1754271811558", "time": "6:00", "duration": 3, "task": "Remove bedding and change into bathrobe", "days": [true,true,true,true,true,true,true] }, { "id": "c16", "time": "6:03", "duration": 1, "task": "Push trundle bed under bunkbed", "days": [true,true,true,true,true,true,true] }, { "id": "c1754271744417", "time": "6:04", "duration": 3, "task": "Start washer with sheets/pjs", "days": [true,true,true,true,true,true,true] }, { "id": "c17", "time": "6:07", "duration": 12, "task": "Shower & wash face", "days": [true,true,true,true,true,true,true] }, { "id": "c18", "time": "6:19", "duration": 3, "task": "Get dressed", "days": [true,true,true,true,true,true,true] }, { "id": "c1754272011441", "time": "6:22", "duration": 2, "task": "Brush hair", "days": [true,true,true,true,true,true,true] }, { "id": "c19", "time": "6:24", "duration": 3, "task": "Brush teeth", "days": [true,true,true,true,true,true,true] }, { "id": "c1754272175149", "time": "6:27", "duration": 1, "task": "Put Dylan water bottle in tote", "days": [true,true,true,true,true,true,true] }, { "id": "c21", "time": "6:28", "duration": 5, "task": "Clean room", "days": [true,true,true,true,true,true,true] }, { "id": "c1754272799169", "time": "6:33", "duration": 10, "task": "Straighten up kid's bathroom (close shower curtain, flush/close toilet, trash in can, refill toilet paper, clean off counter, lysol wipe faucets/counter/sinks, lock closet)", "days": [true,true,true,true,true,true,true] }, { "id": "c1754272076284", "time": "6:43", "duration": 10, "task": "Serve out food to plates", "days": [true,true,true,true,true,true,true] }, { "id": "c15", "time": "6:53", "duration": 5, "task": "Get Ben in highchair with tray and bib ", "days": [true,true,true,true,true,true,true] } ],
                    william: [ { "id": "c26", "time": "6:00", "duration": 3, "task": "Bring water bottle to take pill", "days": [true,true,true,true,true,true,true] }, { "id": "c1754272290555", "time": "6:03", "duration": 1, "task": "Put William water bottle in tote", "days": [true,true,true,true,true,true,true] }, { "id": "c1754272242707", "time": "6:04", "duration": 1, "task": "Put Kanoa's dog bed away", "days": [true,true,true,true,true,true,true] }, { "id": "c27", "time": "6:05", "duration": 3, "task": "Get dressed", "days": [true,true,true,true,true,true,true] }, { "id": "c1754273123809", "time": "6:08", "duration": 10, "task": "Unload dishwasher", "days": [true,true,true,true,true,true,true] }, { "id": "c1754273137503", "time": "6:18", "duration": 5, "task": "Load dishwasher", "days": [true,true,true,true,true,true,true] }, { "id": "c40", "time": "6:23", "duration": 5, "task": "Set table", "days": [true,true,true,true,true,true,true] }, { "id": "c25", "time": "6:28", "duration": 3, "task": "Vitamins", "days": [true,true,true,true,true,true,true] }, { "id": "c24", "time": "6:31", "duration": 3, "task": "Fill cups: M-Th: water; F-Su: juice", "days": [true,true,true,true,true,true,true] }, { "id": "c30", "time": "6:34", "duration": 3, "task": "Make bed", "days": [true,true,true,true,true,true,true] }, { "id": "c31", "time": "6:37", "duration": 5, "task": "Clean room", "days": [true,true,true,true,true,true,true] }, { "id": "c28", "time": "6:42", "duration": 3, "task": "Brush teeth", "days": [true,true,true,true,true,true,true] }, { "id": "c29", "time": "6:45", "duration": 2, "task": "Brush hair", "days": [true,true,true,true,true,true,true] }, { "id": "c1754273257231", "time": "6:47", "duration": 2, "task": "Carry water bottle tote downstairs ", "days": [true,true,true,true,true,true,true] }, { "id": "c1754273281186", "time": "6:49", "duration": 5, "task": "Fill water bottles and put on hutch", "days": [true,true,true,true,true,true,true] } ],
                    vivian: [ { "id": "c1754274065721", "time": "6:30", "duration": 3, "task": "Help Marian get clothes out", "days": [true,true,true,true,true,true,true] }, { "id": "c35", "time": "6:33", "duration": 5, "task": "Get dressed", "days": [true,true,true,true,true,true,true] }, { "id": "c38", "time": "6:38", "duration": 3, "task": "Make bed", "days": [true,true,true,true,true,true,true] }, { "id": "c1754274021667", "time": "6:41", "duration": 1, "task": "Put Vivian water bottle in tote", "days": [true,true,true,true,true,true,true] }, { "id": "c39", "time": "6:42", "duration": 10, "task": "Clean room", "days": [true,true,true,true,true,true,true] }, { "id": "c36", "time": "6:52", "duration": 3, "task": "Brush teeth", "days": [true,true,true,true,true,true,true] }, { "id": "c37", "time": "6:55", "duration": 5, "task": "Brush hair", "days": [true,true,true,true,true,true,true] }, { "id": "c1754274624343", "time": "7:00", "duration": 3, "task": "Take meds", "days": [true,true,true,true,true,true,true] } ],
                    eleanor: [ { "id": "c1754273938176", "time": "6:30", "duration": 5, "task": "Get dressed", "days": [true,true,true,true,true,true,true] }, { "id": "c1754273953432", "time": "6:35", "duration": 1, "task": "Pull-up to trash", "days": [true,true,true,true,true,true,true] }, { "id": "c20", "time": "6:36", "duration": 3, "task": "Make bed", "days": [true,true,true,true,true,true,true] }, { "id": "c1754274184969", "time": "6:39", "duration": 1, "task": "Put Eleanor & Marian water bottles in tote", "days": [true,true,true,true,true,true,true] }, { "id": "c1754274123305", "time": "6:40", "duration": 2, "task": "All dirty laundry to hamper", "days": [true,true,true,true,true,true,true] }, { "id": "c34", "time": "6:42", "duration": 10, "task": "Clean room", "days": [true,true,true,true,true,true,true] }, { "id": "c1754273851073", "time": "6:52", "duration": 3, "task": "Brush teeth", "days": [true,true,true,true,true,true,true] }, { "id": "c1754273854043", "time": "6:55", "duration": 5, "task": "Brush hair", "days": [true,true,true,true,true,true,true] } ],
                    nathan: [ { "id": "c42", "time": "6:30", "duration": 3, "task": "Make bed" }, { "id": "c14", "time": "6:33", "duration": 3, "task": "Get dressed" }, { "id": "c1754274554128", "time": "6:36", "duration": 5, "task": "Clean room" }, { "id": "c33", "time": "6:41", "duration": 2, "task": "Take Nate & Ben water bottles to tote" }, { "id": "c1754274307246", "time": "6:43", "duration": 2, "task": "All dirty laundry to hamper" }, { "id": "c1754274397290", "time": "6:45", "duration": 3, "task": "Brush teeth" }, { "id": "c1754274414570", "time": "6:48", "duration": 2, "task": "Brush hair" }, { "id": "c1754273511793", "time": "6:50", "duration": 3, "task": "Feed dogs" }, { "id": "c1754273562073", "time": "6:53", "duration": 3, "task": "Give dogs water" } ]
                }},
                { id: 'block2', title: 'Block 2: Home Blessing', startTime: '7:45', endTime: '8:15', chores: {
                    tristan: [ { id: 'c43', time: '7:45', duration: 15, task: 'Clean living room' } ], dylan: [ { id: 'c45', time: '7:45', duration: 15, task: 'Clear & wipe table' } ], william: [ { id: 'c47', time: '7:45', duration: 15, task: 'Sweep dining room' } ], vivian: [ { id: 'c49', time: '7:45', duration: 15, task: 'Clean playroom' } ], eleanor: [ { id: 'c50', time: '7:45', duration: 15, task: 'Clean living room' } ]
                }},
                { id: 'block3', title: 'Block 3: Lunch Chores', startTime: '12:00', endTime: '12:15', chores: {
                    tristan: [ { id: 'c51', time: '12:00', duration: 15, task: 'Clear & wipe table' } ], dylan: [ { id: 'c52', time: '12:00', duration: 15, task: 'Load dishwasher' } ], william: [ { id: 'c53', time: '12:00', duration: 15, task: 'Sweep dining room' } ], vivian: [ { id: 'c54', time: '12:00', duration: 15, task: 'Clean playroom' } ], eleanor: [ { id: 'c55', time: '12:00', duration: 15, task: 'Clean living room' } ]
                }},
                { id: 'block4', title: 'Block 4: School Chores', startTime: '3:15', endTime: '3:30', chores: {
                    tristan: [ { id: 'c56', time: '3:15', duration: 15, task: 'Clean school room' } ], dylan: [ { id: 'c57', time: '3:15', duration: 15, task: 'Clean school room' } ]
                }},
                { id: 'block5', title: 'Block 5: Afternoon Chores', startTime: '4:00', endTime: '4:30', chores: {
                    tristan: [ { id: 'c58', time: '4:00', duration: 30, task: 'Clean living room & playroom' } ], dylan: [ { id: 'c61', time: '4:00', duration: 30, task: 'Clean living room & playroom' } ], william: [ { id: 'c64', time: '4:00', duration: 30, task: 'Clean living room & playroom' } ], vivian: [ { id: 'c67', time: '4:00', duration: 30, task: 'Clean living room & playroom' } ]
                }},
                { id: 'block6', title: 'Block 6: Before Dinner Chores', startTime: '6:30', endTime: '6:45', chores: {
                    tristan: [ { id: 'c70', time: '6:30', duration: 15, task: 'Set table & Prep sippy cups' } ], dylan: [ { id: 'c71', time: '6:30', duration: 15, task: 'Set table & Fill cups' } ], william: [ { id: 'c72', time: '6:30', duration: 15, task: 'Clean playroom' } ], vivian: [ { id: 'c73', time: '6:30', duration: 15, task: 'Clean living room' } ], eleanor: [ { id: 'c74', time: '6:30', duration: 15, task: 'Clean playroom' } ]
                }},
                { id: 'block7', title: 'Block 7: Bedtime Chores', startTime: '7:15', endTime: '7:45', chores: {
                    tristan: [ { id: 'c75', time: '7:15', duration: 10, task: 'Let dogs out' } ], dylan: [ { id: 'c78', time: '7:15', duration: 10, task: 'Put away food' } ], william: [ { id: 'c81', time: '7:15', duration: 10, task: 'Kitchen trash & replace bag' } ], vivian: [ { id: 'c84', time: '7:15', duration: 10, task: 'Put chairs up on dining table' } ], eleanor: [ { id: 'c86', time: '7:15', duration: 15, task: 'Load & start dishwasher' } ], nathan: [ { id: 'c87', time: '7:15', duration: 15, task: 'Hand wash dishes & bibs' } ]
                }}
            ]
        };

        // --- APP STATE ---
        let appData = null;
        let draggedChore = null;
        let db;

        // --- FIREBASE INITIALIZATION ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        db = firebase.firestore();
        const choreRef = db.collection('app').doc('choreData');

        // --- NEW JAVASCRIPT LOGIC ---
        const signInContainer = document.getElementById('signin-container');
        const mainContent = document.getElementById('main-content');
        const provider = new firebase.auth.GoogleAuthProvider();

        document.getElementById('google-signin-btn').addEventListener('click', () => {
            auth.signInWithPopup(provider)
                .catch(error => {
                    console.error("Google sign-in failed:", error);
                    alert("Sign-in failed. Please check the console for details.");
                });
        });

        auth.onAuthStateChanged(user => {
            if (user) {
                console.log("User is signed in:", user.displayName);
                signInContainer.style.display = 'none';
                mainContent.style.display = 'block';
                choreRef.onSnapshot(doc => {
                    if (doc.exists) {
                        appData = doc.data();
                        renderBoard();
                    } else {
                        console.log("No data found in Firestore, initializing with default data.");
                        appData = defaultAppData;
                        saveData();
                    }
                }, err => {
                    console.error("Error listening to chore data:", err);
                });
            } else {
                console.log("User is signed out.");
                signInContainer.style.display = 'block';
                mainContent.style.display = 'none';
            }
        });

        // --- CORE LOGIC & UTILITIES ---
        function saveData() {
            if (auth.currentUser) {
                choreRef.set(appData).catch(error => console.error("Error writing document: ", error));
            }
        }

        function getActiveBlock() {
            if (!appData) return null;
            return appData.choreBlocks.find(b => b.id === appData.activeBlockId);
        }

        function timeToMinutes(timeStr) {
            if (!timeStr || !timeStr.includes(':')) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return (hours * 60) + minutes;
        }

        function minutesToTime(totalMinutes) {
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }
        
        function formatTime(timeStr) {
            if (!timeStr || !timeStr.includes(':')) return '';
            let [hours, minutes] = timeStr.split(':');
            return `${parseInt(hours, 10)}:${minutes}`;
        }

        function recalculateTimes(childId) {
            const block = getActiveBlock();
            if (!block) return;
            const chores = block.chores[childId];
            if (!chores || chores.length === 0) return;
            for (let i = 1; i < chores.length; i++) {
                const prevChore = chores[i - 1];
                const prevStartTimeMinutes = timeToMinutes(prevChore.time);
                const prevDurationMinutes = parseInt(prevChore.duration, 10) || 0;
                chores[i].time = minutesToTime(prevStartTimeMinutes + prevDurationMinutes);
            }
        }

        function recalculateFollowingChores(childId, startIndex) {
            const block = getActiveBlock();
            if (!block) return;
            const chores = block.chores[childId];
            if (!chores || chores.length < 2) return;
            for (let i = startIndex + 1; i < chores.length; i++) {
                const prevChore = chores[i - 1];
                const prevStartTimeMinutes = timeToMinutes(prevChore.time);
                const prevDurationMinutes = parseInt(prevChore.duration, 10) || 0;
                chores[i].time = minutesToTime(prevStartTimeMinutes + prevDurationMinutes);
            }
        }

        function calculateTotalDuration(childId) {
            const block = getActiveBlock();
            if (!block) return 0;
            const chores = block.chores[childId] || [];
            return chores.reduce((total, chore) => total + (parseInt(chore.duration, 10) || 0), 0);
        }

        function checkAllOverages() {
            const block = getActiveBlock();
            if (!block) return;
            const totalBlockMinutes = timeToMinutes(block.endTime) - timeToMinutes(block.startTime);

            appData.children.forEach(child => {
                const childsTotalDuration = calculateTotalDuration(child.id);
                const warningIcon = document.getElementById(`warning-${child.id}`);
                if (warningIcon) {
                    warningIcon.classList.toggle('hidden', childsTotalDuration <= totalBlockMinutes);
                }
            });
        }
        
        function updateChoreBlockHeader() {
            const block = getActiveBlock();
            if (!block) return;
            document.getElementById('start-time').innerText = block.startTime;
            document.getElementById('end-time').innerText = block.endTime;
        }

        function populateBlockSelector() {
            const select = document.getElementById('chore-block-select');
            select.innerHTML = '';
            appData.choreBlocks.forEach(block => {
                const option = document.createElement('option');
                option.value = block.id;
                option.textContent = block.title;
                if (block.id === appData.activeBlockId) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        function renderBoard() {
            if (!appData) return;
            populateBlockSelector();
            updateChoreBlockHeader();
            const container = document.getElementById('columns-container');
            container.innerHTML = '';
            const block = getActiveBlock();
            if (!block) return;

            appData.children.forEach(child => {
                const column = document.createElement('div');
                column.id = `column-${child.id}`;
                column.className = 'child-column bg-gray-50 rounded-xl p-2 flex flex-col space-y-2';
                column.dataset.childId = child.id;

                column.innerHTML = `
                    <h2 class="text-lg font-bold text-center text-white p-2 rounded-lg flex items-center justify-center" style="background-color: ${child.color};">
                        ${child.name}
                        <span id="warning-${child.id}" class="warning-icon hidden ml-2" title="Chores exceed available time!">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-300" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </span>
                    </h2>
                    <div id="chores-${child.id}" class="chore-list flex-grow min-h-[200px] space-y-1.5"></div>
                    <button class="add-chore-btn no-print mt-2 w-full bg-gray-200 text-gray-700 font-semibold py-1.5 px-2 rounded-lg hover:bg-gray-300 transition-colors text-sm" data-child-id="${child.id}">+ Add Chore</button>
                `;

                const choreList = column.querySelector(`#chores-${child.id}`);
                (block.chores[child.id] || []).forEach(chore => {
                    choreList.appendChild(createChoreElement(chore, child.id));
                });
                
                container.appendChild(column);
            });
            
            checkAllOverages();
            addEventListeners();
        }
        
        function formatDays(daysArray) {
            const dayLabels = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
            if (!daysArray || !Array.isArray(daysArray)) {
                return 'Daily';
            }
            const weekdays = daysArray.slice(0, 5);
            const weekends = daysArray.slice(5, 7);

            if (daysArray.every(d => d)) return 'Daily';
            if (weekdays.every(d => d) && weekends.every(d => !d)) return 'Weekdays';
            if (weekdays.every(d => !d) && weekends.every(d => d)) return 'Weekends';

            const selectedDays = daysArray.map((isSelected, i) => isSelected ? dayLabels[i] : null).filter(Boolean);
            return selectedDays.join(', ') || 'Never';
        }

        function createChoreElement(chore, childId) {
            const choreItem = document.createElement('div');
            choreItem.id = chore.id;
            choreItem.className = 'chore-item bg-white p-2 rounded-lg shadow-sm cursor-pointer hover:shadow-md transition-shadow duration-200 relative';
            choreItem.dataset.choreId = chore.id;
            choreItem.dataset.childId = childId;

            choreItem.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="chore-time font-bold text-sm text-gray-800">${formatTime(chore.time)}</div>
                    <div class="text-xs text-gray-500 font-medium">${String(chore.duration).padStart(2, '0')} min</div>
                </div>
                <p class="text-gray-600 mt-1 text-sm">${chore.task}</p>
                <div class="text-xs text-gray-400 mt-1">${formatDays(chore.days)}</div>
            `;
            return choreItem;
        }

        function addEventListeners() {
            document.querySelectorAll('.chore-item').forEach(i => { 
                i.addEventListener('click', (e) => {
                    openEditModal(e.currentTarget.dataset.childId, e.currentTarget.dataset.choreId);
                });
                i.draggable = true;
                i.addEventListener('dragstart', handleDragStart); 
                i.addEventListener('dragend', handleDragEnd); 
            });
            document.querySelectorAll('.chore-list').forEach(l => { l.addEventListener('dragover', handleDragOver); l.addEventListener('dragleave', handleDragLeave); l.addEventListener('drop', handleDrop); });
            document.querySelectorAll('[contenteditable="true"]').forEach(f => { f.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); e.target.blur(); } }); });
            document.getElementById('start-time').addEventListener('blur', handleTimeRangeEdit);
            document.getElementById('end-time').addEventListener('blur', handleTimeRangeEdit);
            
            document.querySelectorAll('.add-chore-btn').forEach(b => b.addEventListener('click', (e) => openAddModal(e.currentTarget.dataset.childId)));
            document.getElementById('open-add-modal-btn').addEventListener('click', () => openAddModal());

            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            document.getElementById('chore-form').addEventListener('submit', handleSaveChore);
            document.getElementById('delete-chore-btn').addEventListener('click', handleDeleteChoreFromModal);
            document.getElementById('chore-block-select').addEventListener('change', handleBlockChange);
        }

        // --- MODAL & HEADER ---
        function openAddModal(childId = null) {
            const modal = document.getElementById('chore-modal');
            const form = document.getElementById('chore-form');
            form.reset();
            document.getElementById('modal-title').textContent = 'Add New Chore';
            document.getElementById('edit-chore-id').value = '';
            
            const childSelectContainer = document.getElementById('modal-child-select-container');
            const childSelect = document.getElementById('modal-child-select');

            if (childId) {
                document.getElementById('edit-child-id').value = childId;
                childSelectContainer.classList.add('modal-hidden');
            } else {
                childSelectContainer.classList.remove('modal-hidden');
                childSelect.innerHTML = '';
                appData.children.forEach(child => {
                    const option = document.createElement('option');
                    option.value = child.id;
                    option.textContent = child.name;
                    childSelect.appendChild(option);
                });
                document.getElementById('edit-child-id').value = childSelect.value;
            }

            const daySelector = document.getElementById('day-selector');
            const days = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
            daySelector.innerHTML = '';
            days.forEach((day, index) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.textContent = day;
                button.dataset.dayIndex = index;
                button.className = 'day-btn border rounded-md py-2 text-sm font-medium bg-white text-gray-700 hover:bg-gray-50';
                button.classList.add('selected');
                button.addEventListener('click', () => button.classList.toggle('selected'));
                daySelector.appendChild(button);
            });

            document.getElementById('delete-chore-btn').classList.add('hidden');
            modal.classList.remove('modal-hidden');
        }

        function openEditModal(childId, choreId) {
            const modal = document.getElementById('chore-modal');
            const form = document.getElementById('chore-form');
            const block = getActiveBlock();
            const chore = block.chores[childId].find(c => c.id === choreId);

            if (!chore) return;

            document.getElementById('modal-title').textContent = 'Edit Chore';
            document.getElementById('edit-chore-id').value = choreId;
            document.getElementById('edit-child-id').value = childId;
            
            form.elements.task.value = chore.task;
            form.elements.time.value = chore.time;
            form.elements.duration.value = chore.duration;
            
            document.getElementById('modal-child-select-container').classList.add('modal-hidden');

            const daySelector = document.getElementById('day-selector');
            const days = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
            daySelector.innerHTML = '';
            (chore.days || [true,true,true,true,true,true,true]).forEach((isSelected, index) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.textContent = days[index];
                button.dataset.dayIndex = index;
                button.className = 'day-btn border rounded-md py-2 text-sm font-medium bg-white text-gray-700 hover:bg-gray-50';
                if (isSelected) button.classList.add('selected');
                button.addEventListener('click', () => button.classList.toggle('selected'));
                daySelector.appendChild(button);
            });
            
            document.getElementById('delete-chore-btn').classList.remove('hidden');
            modal.classList.remove('modal-hidden');
        }

        function closeModal() {
            document.getElementById('chore-modal').classList.add('modal-hidden');
        }

        // --- EVENT HANDLERS ---
        function handleBlockChange(e) {
            appData.activeBlockId = e.target.value;
            saveData();
        }

        function handleTimeRangeEdit(e) {
            const block = getActiveBlock();
            if (!block) return;
            const field = e.target.id === 'start-time' ? 'startTime' : 'endTime';
            const newTime = e.target.innerText.trim();
            if (/^\d{1,2}:\d{2}$/.test(newTime)) {
                block[field] = newTime;
                
                if (field === 'startTime') {
                    appData.children.forEach(child => {
                        const choreList = block.chores[child.id];
                        if (choreList && choreList.length > 0) {
                            choreList[0].time = newTime;
                            recalculateTimes(child.id);
                        }
                    });
                }
                saveData();
            } else {
                e.target.innerText = block[field];
            }
        }

        function handleSaveChore(e) {
            e.preventDefault();
            const block = getActiveBlock();
            if (!block) return;
            
            const form = e.target;
            const choreId = document.getElementById('edit-chore-id').value;
            let childId = document.getElementById('edit-child-id').value;

            const task = form.elements.task.value;
            const time = form.elements.time.value;
            const duration = parseInt(form.elements.duration.value, 10) || 0;
            const savedChoreId = choreId || 'c' + Date.now();

            const selectedDays = Array.from(document.querySelectorAll('#day-selector .day-btn'))
                                     .map(btn => btn.classList.contains('selected'));

            if (!task.trim()) return;

            if (choreId) { // Editing existing chore
                const choreList = block.chores[childId];
                const choreIndex = choreList.findIndex(c => c.id === choreId);
                if (choreIndex > -1) {
                    const chore = choreList[choreIndex];
                    chore.task = task;
                    chore.time = time;
                    chore.duration = duration;
                    chore.days = selectedDays;
                }
            } else { // Adding new chore
                childId = document.getElementById('modal-child-select').value;
                const newChore = { id: savedChoreId, time, duration, task, days: selectedDays };
                if (!block.chores[childId]) block.chores[childId] = [];
                block.chores[childId].push(newChore);
            }
            
            block.chores[childId].sort((a, b) => timeToMinutes(a.time) - timeToMinutes(b.time));

            const savedChoreIndex = block.chores[childId].findIndex(c => c.id === savedChoreId);
            recalculateFollowingChores(childId, savedChoreIndex);
            
            closeModal();
            saveData();
        }
        
        function handleDragStart(e) {
            draggedChore = { choreId: e.target.id, sourceChildId: e.target.closest('.child-column').dataset.childId };
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedChore = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.closest('.child-column').classList.add('drag-over');
        }
        
        function handleDragLeave(e) {
            e.currentTarget.closest('.child-column').classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            const block = getActiveBlock();
            if (!block) return;
            const dropList = e.currentTarget;
            dropList.closest('.child-column').classList.remove('drag-over');
            if (!draggedChore) return;

            const targetChildId = dropList.closest('.child-column').dataset.childId;
            const { choreId, sourceChildId } = draggedChore;
            const sourceChores = block.chores[sourceChildId];
            const choreIndex = sourceChores.findIndex(c => c.id === choreId);
            if (choreIndex === -1) return;
            const [movedChore] = sourceChores.splice(choreIndex, 1);

            const targetChores = block.chores[targetChildId] || [];
            const afterElement = [...dropList.querySelectorAll('.chore-item:not(.dragging)')].reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = e.clientY - box.top - box.height / 2;
                return (offset < 0 && offset > closest.offset) ? { offset, element: child } : closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
            
            if (afterElement == null) {
                targetChores.push(movedChore);
            } else {
                const insertIndex = targetChores.findIndex(c => c.id === afterElement.id);
                targetChores.splice(insertIndex, 0, movedChore);
            }
            if (!block.chores[targetChildId]) block.chores[targetChildId] = targetChores;

            recalculateTimes(sourceChildId);
            recalculateTimes(targetChildId);
            saveData();
        }
        
        function handleDeleteChoreFromModal() {
            const block = getActiveBlock();
            if (!block) return;
            const choreId = document.getElementById('edit-chore-id').value;
            const childId = document.getElementById('edit-child-id').value;
            
            if (choreId && childId && window.confirm('Are you sure you want to delete this chore?')) {
                const choreList = block.chores[childId];
                const choreIndex = choreList.findIndex(c => c.id === choreId);
                if (choreIndex > -1) {
                    choreList.splice(choreIndex, 1);
                    recalculateTimes(childId);
                    closeModal();
                    saveData();
                }
            }
        }

        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</html>
