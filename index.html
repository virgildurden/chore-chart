<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casey Family Chores</title>
    <meta name="theme-color" content="#ffffff"/>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Lexend', sans-serif; }
        
        #columns-container { gap: 0; }
        .child-column, .room-column { border-right: 1px solid #e5e7eb; }
        .child-column:last-child, .room-column:last-child { border-right: none; }
        .chore-item {
            border-radius: 0;
            box-shadow: none;
            border-bottom: 1px solid #f3f4f6;
            padding: 6px 8px;
        }
        .dragging { opacity: 0.5; background: #f0f0f0; border: 2px dashed #ccc; }
        .drag-over { background-color: #eef2ff; }
        .warning-icon { display: inline-block; vertical-align: middle; }
        .day-btn.selected { background-color: #4f46e5; color: white; border-color: #4f46e5; }
        .day-btn { transition: background-color 0.2s, color 0.2s, border-color 0.2s; }
        .hidden { display: none; }

        @media print {
            body { -webkit-print-color-adjust: exact; color-adjust: exact; background-color: white !important; }
            .no-print { display: none !important; }
            #main-content { display: none !important; }
            #print-container { display: block !important; }
            #print-columns { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
            .print-child-column { page-break-inside: avoid; }
            .print-chore-item { border-top: 1px solid #374151; padding: 4px 0; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">

    <div id="signin-container" class="text-center mt-20">
        <button id="google-signin-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-colors">
            Sign In with Google
        </button>
    </div>

    <div id="main-content" class="max-w-screen-2xl mx-auto hidden">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 no-print gap-4">
            <div class="flex items-center gap-4">
                <button id="view-toggle-btn" class="bg-white text-black font-bold py-2 px-4 rounded-none border border-black">Switch to Room View</button>
            </div>
            <div class="flex items-center gap-4">
                <button id="chore-block-btn" class="bg-white text-black font-bold py-2 px-4 rounded-none border border-black"></button>
            </div>
            <div class="flex space-x-2">
                 <button id="open-add-modal-btn" class="bg-white text-black font-bold py-2 px-4 rounded-none border border-black">Add Chore</button>
                <button onclick="prepareAndPrint()" class="bg-white text-black font-bold py-2 px-4 rounded-none border border-black">Print</button>
                <button id="export-csv-btn" class="bg-white text-black font-bold py-2 px-4 rounded-none border border-black">Export All</button>
            </div>
        </div>

        <div id="chore-board" class="chore-board bg-white p-4 sm:p-6 rounded-2xl shadow-lg">
            <div id="columns-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6"></div>
        </div>
    </div>

    <div id="print-container" class="hidden"></div>

    <div id="chore-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full no-print z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900 text-center">Edit Chore</h3>
                <form id="chore-form" class="mt-4 space-y-4">
                    <input type="hidden" id="edit-chore-id">
                    <input type="hidden" id="edit-child-id">
                    <div id="modal-child-select-container" class="hidden">
                        <label for="modal-child-select" class="text-sm font-medium text-gray-700 block">Assign to Child</label>
                        <select id="modal-child-select" name="child" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                    </div>
                    <div>
                        <label for="modal-task-input" class="text-sm font-medium text-gray-700 block">Chore Description</label>
                        <textarea id="modal-task-input" name="task" rows="2" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required></textarea>
                    </div>
                    <div>
                        <label for="modal-room-select" class="text-sm font-medium text-gray-700 block">Room</label>
                        <select id="modal-room-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                        <input type="text" id="modal-new-room-input" placeholder="Enter new room name" class="hidden mt-2 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="modal-time-input" class="text-sm font-medium text-gray-700 block">Start Time</label>
                            <input type="time" id="modal-time-input" name="time" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                        </div>
                        <div>
                            <label for="modal-duration-input" class="text-sm font-medium text-gray-700 block">Duration (min)</label>
                            <input type="number" id="modal-duration-input" name="duration" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="10" required>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700 block">Days</label>
                        <div id="day-selector" class="mt-2 grid grid-cols-7 gap-1"></div>
                    </div>
                    <div class="flex items-center pt-3 space-x-2">
                        <button id="save-chore-btn" type="submit" class="flex-grow w-full px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Save Changes</button>
                        <button id="delete-chore-btn" type="button" class="flex-shrink-0 px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Delete</button>
                    </div>
                </form>
                <button id="close-modal-btn" class="mt-2 text-sm text-gray-500 hover:text-gray-700 w-full text-center">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center no-print z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-auto">
            <h3 id="confirm-modal-title" class="text-lg font-medium text-gray-900">Are you sure?</h3>
            <p id="confirm-modal-text" class="mt-2 text-sm text-gray-500">Do you really want to delete this chore? This action cannot be undone.</p>
            <div class="mt-4 flex justify-end space-x-3">
                <button id="confirm-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="confirm-ok-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <div id="chore-block-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full no-print z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">Select Chore Block</h3>
                <div id="chore-block-list" class="mt-4 space-y-2"></div>
                <div class="mt-4">
                    <input type="text" id="new-chore-block-input" placeholder="New chore block name" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    <button id="add-chore-block-btn" class="mt-2 w-full px-4 py-2 bg-green-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Add New Block</button>
                </div>
                <button id="close-chore-block-modal-btn" class="mt-4 w-full text-sm text-gray-500 hover:text-gray-700 text-center">Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>

    <script id="app-script">
        const firebaseConfig = {
            apiKey: "AIzaSyCXWZN9QZkIqXyx234nBOTI3M7rcGNU9p8",
            authDomain: "casey-family-chores.firebaseapp.com",
            projectId: "casey-family-chores",
            storageBucket: "casey-family-chores.appspot.com",
            messagingSenderId: "211060942093",
            appId: "1:211060942093:web:83973adc673dcfd1f77c44"
        };
        
        let appData = null, draggedChore = null, db, currentView = 'child';

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        db = firebase.firestore();
        const choreRef = db.collection('app').doc('choreData');

        const signInContainer = document.getElementById('signin-container');
        const mainContent = document.getElementById('main-content');
        const provider = new firebase.auth.GoogleAuthProvider();

        document.getElementById('google-signin-btn').addEventListener('click', () => auth.signInWithPopup(provider).catch(console.error));

        auth.onAuthStateChanged(user => {
            if (user) {
                const authorizedEmails = ['virgil.durden@gmail.com', 'ajcasey77@gmail.com'];
                if (authorizedEmails.includes(user.email)) {
                    signInContainer.style.display = 'none';
                    mainContent.classList.remove('hidden');
                    choreRef.onSnapshot(doc => {
                        if (doc.exists) { 
                            appData = doc.data();
                            if (!appData.choreBlocks || appData.choreBlocks.length === 0) {
                                const defaultBlock = { id: 'b' + Date.now(), title: 'Default Block', chores: {} };
                                appData.choreBlocks = [defaultBlock];
                                appData.activeBlockId = defaultBlock.id;
                            } else if (!appData.activeBlockId || !appData.choreBlocks.find(b => b.id === appData.activeBlockId)) {
                                appData.activeBlockId = appData.choreBlocks[0].id;
                            }
                            renderBoard(); 
                        }
                    }, console.error);
                } else {
                    alert("You are not authorized.");
                    auth.signOut();
                }
            } else {
                signInContainer.style.display = 'block';
                mainContent.classList.add('hidden');
            }
        });

        function saveData() { if (auth.currentUser) choreRef.set(appData).catch(console.error); }
        function getActiveBlock() { return appData ? appData.choreBlocks.find(b => b.id === appData.activeBlockId) : null; }
        function timeToMinutes(t) { if (!t || !t.includes(':')) return 0; const [h, m] = t.split(':').map(Number); return h * 60 + m; }
        function minutesToTime(m) { return `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`; }
        function formatTime(t) { if (!t || !t.includes(':')) return ''; let [h, m] = t.split(':'); return `${parseInt(h,10)}:${m}`; }
        function recalculateTimes(childId) { const block = getActiveBlock(); if (!block) return; const chores = block.chores[childId]; if (!chores || chores.length === 0) return; for (let i = 1; i < chores.length; i++) { const prevChore = chores[i - 1]; const prevStartTimeMinutes = timeToMinutes(prevChore.time); const prevDurationMinutes = parseInt(prevChore.duration, 10) || 0; chores[i].time = minutesToTime(prevStartTimeMinutes + prevDurationMinutes); } } 
        function recalculateFollowingChores(childId, startIndex) { const block = getActiveBlock(); if (!block) return; const chores = block.chores[childId]; if (!chores || chores.length < 2) return; for (let i = startIndex + 1; i < chores.length; i++) { const prevChore = chores[i - 1]; const prevStartTimeMinutes = timeToMinutes(prevChore.time); const prevDurationMinutes = parseInt(prevChore.duration, 10) || 0; chores[i].time = minutesToTime(prevStartTimeMinutes + prevDurationMinutes); } }
        
        function renderBoard() {
            if (!appData) return;
            updateChoreBlockButton();
            if (currentView === 'child') {
                renderChildView();
            } else {
                renderRoomView();
            }
            addEventListeners();
        }

        function renderChildView() {
            const container = document.getElementById('columns-container');
            container.innerHTML = '';
            container.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6';
            const block = getActiveBlock();
            if (!block) return;

            appData.children.forEach(child => {
                const column = document.createElement('div');
                column.className = 'child-column bg-gray-50 p-2 flex flex-col space-y-2';
                column.dataset.childId = child.id;
                column.innerHTML = `<h2 class="text-lg font-bold text-center text-white p-2" style="background-color: ${child.color};">${child.name}</h2><div id="chores-${child.id}" class="chore-list flex-grow min-h-[200px]"></div><button class="add-chore-btn no-print mt-2 w-full bg-gray-200 text-gray-700 font-semibold py-1.5 px-2 rounded-lg" data-child-id="${child.id}">+ Add</button>`;
                
                const choreList = column.querySelector(`#chores-${child.id}`);
                if (block.chores && block.chores[child.id]) {
                    block.chores[child.id].forEach(chore => choreList.appendChild(createChoreElement(chore, child.id)));
                }
                container.appendChild(column);
            });
        }

        function renderRoomView() {
            const container = document.getElementById('columns-container');
            container.innerHTML = '';
            container.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4';
            const block = getActiveBlock();
            if (!block || !block.chores) return;

            const choresByRoom = {};
            appData.children.forEach(child => {
                (block.chores[child.id] || []).forEach(chore => {
                    const room = chore.room || 'Unassigned';
                    if (!choresByRoom[room]) choresByRoom[room] = [];
                    choresByRoom[room].push({ ...chore, childName: child.name, childColor: child.color, childId: child.id });
                });
            });

            Object.keys(choresByRoom).sort().forEach(room => {
                const column = document.createElement('div');
                column.className = 'room-column bg-gray-50 p-2 flex flex-col space-y-2';
                column.innerHTML = `<h2 class="text-lg font-bold text-center text-gray-800 bg-gray-200 p-2">${room}</h2><div class="chore-list flex-grow min-h-[200px]"></div>`;
                
                const choreList = column.querySelector('.chore-list');
                choresByRoom[room].sort((a,b) => timeToMinutes(a.time) - timeToMinutes(b.time)).forEach(chore => {
                    choreList.appendChild(createChoreElement(chore, chore.childId, true));
                });
                container.appendChild(column);
            });
        }
        
        function formatDays(daysArray) {
            if (!daysArray || daysArray.every(d => d)) return '';
            const dayLabels = ['m', 't', 'w', 'th', 'f', 'sa', 'su'];
            return daysArray.map((isSelected, i) => isSelected ? dayLabels[i] : null).filter(Boolean).join(', ') || '';
        }

        function createChoreElement(chore, childId, isRoomView = false) {
            const choreItem = document.createElement('div');
            choreItem.id = chore.id;
            choreItem.className = 'chore-item bg-white cursor-pointer hover:bg-gray-50';
            choreItem.dataset.choreId = chore.id;
            choreItem.dataset.childId = childId;

            let assignedToHtml = '';
            if (isRoomView) {
                assignedToHtml = `<div class="text-xs font-bold" style="color: ${chore.childColor};">${chore.childName}</div>`;
            }

            choreItem.innerHTML = `
                <div class="block sm:block print:hidden">
                    <div class="flex justify-between items-center text-xs">
                        <div class="chore-time font-medium text-gray-600">${formatTime(chore.time)}</div>
                        ${assignedToHtml}
                        <div class="days-display text-gray-400 font-medium">${formatDays(chore.days)}</div>
                    </div>
                    <p class="chore-task text-gray-800 text-sm mt-1">${chore.task}</p>
                </div>
            `;
            return choreItem;
        }

        function addEventListeners() {
            document.querySelectorAll('.chore-item').forEach(i => { 
                i.addEventListener('click', (e) => openEditModal(e.currentTarget.dataset.childId, e.currentTarget.dataset.choreId));
                i.draggable = true;
                i.addEventListener('dragstart', handleDragStart); i.addEventListener('dragend', handleDragEnd); 
            });
            document.querySelectorAll('.child-column .chore-list').forEach(l => { l.addEventListener('dragover', handleDragOver); l.addEventListener('dragleave', handleDragLeave); l.addEventListener('drop', handleDrop); });
            document.querySelectorAll('.add-chore-btn').forEach(b => b.addEventListener('click', (e) => openAddModal(e.currentTarget.dataset.childId)));
            document.getElementById('open-add-modal-btn').addEventListener('click', () => openAddModal());
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            document.getElementById('chore-form').addEventListener('submit', handleSaveChore);
            document.getElementById('delete-chore-btn').addEventListener('click', handleDeleteChoreFromModal);
            document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);
            document.getElementById('modal-room-select').addEventListener('change', handleRoomSelectChange);
            document.getElementById('view-toggle-btn').addEventListener('click', handleViewToggle);
            document.getElementById('chore-block-btn').addEventListener('click', openChoreBlockModal);
            document.getElementById('close-chore-block-modal-btn').addEventListener('click', closeChoreBlockModal);
            document.getElementById('add-chore-block-btn').addEventListener('click', handleAddChoreBlock);
        }

        function handleViewToggle() {
            const toggleBtn = document.getElementById('view-toggle-btn');
            currentView = (currentView === 'child') ? 'room' : 'child';
            toggleBtn.textContent = (currentView === 'child') ? 'Switch to Room View' : 'Switch to Child View';
            renderBoard();
        }

        function getAllUniqueRooms() {
            const rooms = new Set();
            if (appData && appData.choreBlocks) {
                appData.choreBlocks.forEach(block => {
                    if (block.chores) Object.values(block.chores).flat().forEach(chore => { if (chore.room) rooms.add(chore.room); });
                });
            }
            return Array.from(rooms).sort();
        }

        function populateRoomSelector(currentRoom = '') {
            const roomSelect = document.getElementById('modal-room-select');
            const newRoomInput = document.getElementById('modal-new-room-input');
            const uniqueRooms = getAllUniqueRooms();
            roomSelect.innerHTML = '';
            uniqueRooms.forEach(room => {
                const option = document.createElement('option');
                option.value = room; option.textContent = room;
                roomSelect.appendChild(option);
            });
            const newRoomOption = document.createElement('option');
            newRoomOption.value = '__new__'; newRoomOption.textContent = '... (Add a new room)';
            roomSelect.appendChild(newRoomOption);
            if (currentRoom && uniqueRooms.includes(currentRoom)) {
                roomSelect.value = currentRoom;
                newRoomInput.classList.add('hidden');
            } else if (currentRoom) {
                roomSelect.value = '__new__';
                newRoomInput.value = currentRoom;
                newRoomInput.classList.remove('hidden');
            } else {
                roomSelect.value = uniqueRooms.length > 0 ? uniqueRooms[0] : '__new__';
                handleRoomSelectChange();
            }
        }

        function handleRoomSelectChange() {
            const roomSelect = document.getElementById('modal-room-select');
            const newRoomInput = document.getElementById('modal-new-room-input');
            if (roomSelect.value === '__new__') {
                newRoomInput.classList.remove('hidden');
                newRoomInput.value = '';
                newRoomInput.focus();
            } else {
                newRoomInput.classList.add('hidden');
            }
        }

        function openAddModal(childId = null) {
            const form = document.getElementById('chore-form');
            form.reset();
            document.getElementById('modal-title').textContent = 'Add New Chore';
            document.getElementById('edit-chore-id').value = '';
            populateRoomSelector();
            const childSelectContainer = document.getElementById('modal-child-select-container');
            const childSelect = document.getElementById('modal-child-select');
            if (childId) {
                document.getElementById('edit-child-id').value = childId;
                childSelectContainer.classList.add('hidden');
            } else {
                childSelectContainer.classList.remove('hidden');
                childSelect.innerHTML = '';
                appData.children.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id; option.textContent = c.name;
                    childSelect.appendChild(option);
                });
                document.getElementById('edit-child-id').value = childSelect.value;
            }
            const daySelector = document.getElementById('day-selector');
            const days = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
            daySelector.innerHTML = '';
            days.forEach((day, index) => {
                const button = document.createElement('button');
                button.type = 'button'; button.textContent = day; button.dataset.dayIndex = index;
                button.className = 'day-btn border rounded-md py-2 text-sm font-medium bg-white text-gray-700 hover:bg-gray-50 selected';
                button.addEventListener('click', () => button.classList.toggle('selected'));
                daySelector.appendChild(button);
            });
            document.getElementById('delete-chore-btn').classList.add('hidden');
            document.getElementById('chore-modal').classList.remove('hidden');
        }

        function openEditModal(childId, choreId) {
            const form = document.getElementById('chore-form');
            const block = getActiveBlock();
            const chore = block.chores[childId].find(c => c.id === choreId);
            if (!chore) return;
            document.getElementById('modal-title').textContent = 'Edit Chore';
            document.getElementById('edit-chore-id').value = choreId;
            document.getElementById('edit-child-id').value = childId;
            form.elements.task.value = chore.task;
            form.elements.time.value = chore.time;
            form.elements.duration.value = chore.duration;
            document.getElementById('modal-child-select-container').classList.add('hidden');
            populateRoomSelector(chore.room || '');
            const daySelector = document.getElementById('day-selector');
            const days = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
            daySelector.innerHTML = '';
            (chore.days || Array(7).fill(true)).forEach((isSelected, index) => {
                 const button = document.createElement('button');
                button.type = 'button'; button.textContent = days[index]; button.dataset.dayIndex = index;
                button.className = 'day-btn border rounded-md py-2 text-sm font-medium bg-white text-gray-700 hover:bg-gray-50';
                if (isSelected) button.classList.add('selected');
                button.addEventListener('click', () => button.classList.toggle('selected'));
                daySelector.appendChild(button);
            });
            document.getElementById('delete-chore-btn').classList.remove('hidden');
            document.getElementById('chore-modal').classList.remove('hidden');
        }

        function handleSaveChore(e) {
            e.preventDefault();
            const block = getActiveBlock();
            if (!block) return;
            const form = e.target;
            const choreId = document.getElementById('edit-chore-id').value;
            let childId = document.getElementById('edit-child-id').value;
            const task = form.elements.task.value;
            let room = document.getElementById('modal-room-select').value;
            if (room === '__new__') { room = document.getElementById('modal-new-room-input').value.trim(); }
            const time = form.elements.time.value;
            const duration = parseInt(form.elements.duration.value, 10) || 0;
            const savedChoreId = choreId || 'c' + Date.now();
            const selectedDays = Array.from(document.querySelectorAll('#day-selector .day-btn')).map(btn => btn.classList.contains('selected'));
            if (!task.trim()) return;

            const updatedChoreData = { task, room, time, duration, days: selectedDays };

            if (choreId) {
                const choreList = block.chores[childId];
                const chore = choreList.find(c => c.id === choreId);
                if (chore) Object.assign(chore, updatedChoreData);
            } else {
                childId = document.getElementById('modal-child-select').value;
                const newChore = { id: savedChoreId, ...updatedChoreData };
                if (!block.chores[childId]) block.chores[childId] = [];
                block.chores[childId].push(newChore);
            }
            
            block.chores[childId].sort((a, b) => timeToMinutes(a.time) - timeToMinutes(b.time));
            const savedChoreIndex = block.chores[childId].findIndex(c => c.id === savedChoreId);
            recalculateFollowingChores(childId, savedChoreIndex);
            closeModal();
            saveData();
        }

        function closeModal() {
            document.getElementById('chore-modal').classList.add('hidden');
            document.getElementById('confirm-modal').classList.add('hidden');
            document.getElementById('chore-block-modal').classList.add('hidden');
        }

        function handleDeleteChoreFromModal() {
            const confirmModal = document.getElementById('confirm-modal');
            confirmModal.classList.remove('hidden');
            
            document.getElementById('confirm-ok-btn').onclick = () => {
                const choreId = document.getElementById('edit-chore-id').value;
                const childId = document.getElementById('edit-child-id').value;
                const block = getActiveBlock();
                if (block && block.chores[childId]) {
                    const choreIndex = block.chores[childId].findIndex(c => c.id === choreId);
                    if (choreIndex > -1) {
                        block.chores[childId].splice(choreIndex, 1);
                        recalculateFollowingChores(childId, choreIndex - 1);
                        saveData();
                    }
                }
                closeModal();
            };

            document.getElementById('confirm-cancel-btn').onclick = () => {
                confirmModal.classList.add('hidden');
            };
        }
        
        function handleDragStart(e) { /* Drag logic */ }
        function handleDragEnd(e) { /* Drag logic */ }
        function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
        function handleDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
        function handleDrop(e) { /* Drop logic */ }

        function exportToCSV() { /* Export logic */ }

        function prepareAndPrint() {
            const block = getActiveBlock();
            if (!block || !appData) return;
            const printContainer = document.getElementById('print-container');
            let childrenWithChores = appData.children.map(child => ({...child, chores: block.chores[child.id] || [], height: (block.chores[child.id] || []).length > 0 ? 2 + (block.chores[child.id] || []).length : 0 })).filter(child => child.height > 0).sort((a, b) => b.height - a.height);
            let col1 = { height: 0, children: [] }, col2 = { height: 0, children: [] };
            childrenWithChores.forEach(child => { if (col1.height <= col2.height) { col1.children.push(child); col1.height += child.height; } else { col2.children.push(child); col2.height += child.height; } });
            const generateColumnHtml = (column) => column.children.map(child => { const choresHtml = child.chores.map(chore => `<div class="print-chore-item flex items-baseline text-sm"><span class="chore-time font-medium text-gray-600 w-12">${formatTime(chore.time)}</span><span class="chore-task text-gray-800 flex-1">${chore.task}</span><span class="days-display text-gray-500 text-xs ml-2">${formatDays(chore.days)}</span></div>`).join(''); return `<div class="print-child-column"><h2 class="text-lg font-bold text-center text-white p-2" style="background-color: ${child.color};">${child.name}</h2><div>${choresHtml}</div></div>`; }).join('');
            printContainer.innerHTML = `<div class="text-center mb-4"><h1 class="text-2xl font-bold">${block.title}</h1><p class="text-lg">${block.startTime} - ${block.endTime}</p></div><div id="print-columns"><div>${generateColumnHtml(col1)}</div><div>${generateColumnHtml(col2)}</div></div>`;
            window.print();
        }

        function updateChoreBlockButton() { const block = getActiveBlock(); if (block) document.getElementById('chore-block-btn').textContent = block.title; }
        function openChoreBlockModal() { document.getElementById('chore-block-modal').classList.remove('hidden'); populateChoreBlockModal(); }
        function closeChoreBlockModal() { document.getElementById('chore-block-modal').classList.add('hidden'); }
        function populateChoreBlockModal() { const list = document.getElementById('chore-block-list'); list.innerHTML = ''; if (!appData || !appData.choreBlocks) return; appData.choreBlocks.forEach(block => { const button = document.createElement('button'); button.textContent = block.title; button.className = `w-full text-left px-4 py-2 text-sm rounded-md ${block.id === appData.activeBlockId ? 'bg-indigo-600 text-white' : 'bg-white text-gray-900 hover:bg-gray-50'}`; button.addEventListener('click', () => handleChoreBlockSelect(block.id)); list.appendChild(button); }); }
        function handleChoreBlockSelect(blockId) { appData.activeBlockId = blockId; saveData(); closeChoreBlockModal(); renderBoard(); }
        function handleAddChoreBlock() { const input = document.getElementById('new-chore-block-input'); const title = input.value.trim(); if (!title) return; const newBlock = { id: 'b' + Date.now(), title: title, chores: {} }; appData.choreBlocks.push(newBlock); appData.activeBlockId = newBlock.id; input.value = ''; saveData(); closeChoreBlockModal(); renderBoard(); }
    </script>
</body>
</html>
